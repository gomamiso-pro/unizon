<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãã˜å¼•ã - UNIZON Softball Team</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        :root {
            --primary-color: #001f44;
            --secondary-color: #ffffff;
            --accent-color: #e74c3c;
        }

        /* ãã˜å¼•ãå°‚ç”¨ã®CSS */
        #kujibiki-page {
            text-align: center;
        }
        #result-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            min-height: 150px; /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ç¢ºä¿ */
        }
        #result-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid var(--accent-color);
            margin-bottom: 10px;
            background-color: #ccc; /* ãƒ­ãƒ¼ãƒ‰ä¸­ã®èƒŒæ™¯ */
            display: none; /* éš ã—ã¦ãŠã */
        }
        #result-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            min-height: 50px;
        }
        #kujibiki-button {
            padding: 15px 40px;
            font-size: 1.5rem;
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border-radius: 10px;
            transition: background-color 0.3s;
        }
        #kujibiki-button:hover:not(:disabled) {
            background-color: #003366;
        }
        #kujibiki-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    
    <header style="justify-content: flex-start;">
        <button class="menu-item" style="margin-right: 15px;" onclick="window.location.href='index.html'">
            ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        </button>
        <h1>
            <span>ãã˜å¼•ãå¤§ä¼šï¼</span>
        </h1>
    </header>

    <main id="app">
        <section id="kujibiki-page" class="page active" style="display: flex; flex-direction: column; align-items: center;">
            <h2>ä»Šæ—¥ã®é‹è©¦ã—</h2>
            
            <p id="loading-message">ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            
            <div id="result-container">
                <img id="result-image" src="" alt="å½“é¸è€…ç”»åƒ">
                <div id="result-name">---</div>
            </div>
            
            <button id="kujibiki-button" onclick="startKujibiki()" disabled>ãã˜ã‚’å¼•ãï¼</button>

            <p style="margin-top: 20px;">â€» ã“ã®ãã˜å¼•ãã¯ã€ã‚¢ãƒ—ãƒªã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>

        </section>
    </main>

    <script>
        // --- ãã˜å¼•ãã®ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        // â˜… ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚¢ãƒ—ãƒªã¨åŒã˜API URLã‚’è¨­å®š â˜…
        const API_URL = "https://script.google.com/macros/s/AKfycbzROz8hBY31FZB0cECHPXF6DJlX2t8t3rOAHaOBAfWE3M4jYiyw6u3TWG3N0WxPbGFM/exec";
        const DEFAULT_IMAGE_PATH = 'images/member/00.png';

        let membersData = []; // ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
        
        const RESULT_IMAGE = document.getElementById('result-image');
        const RESULT_NAME = document.getElementById('result-name');
        const BUTTON = document.getElementById('kujibiki-button');
        const LOADING_MESSAGE = document.getElementById('loading-message');
        let intervalId;

        // ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’éåŒæœŸã§èª­ã¿è¾¼ã‚€é–¢æ•°
        async function loadMembersForKujibiki() {
            LOADING_MESSAGE.textContent = "ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...";
            try {
                const res = await fetch(API_URL);
                const members = await res.json();

                if (Array.isArray(members) && members.length > 0) {
                    membersData = members.map(m => {
                        const memberNumber = String(m.number || '00').trim();
                        // ç”»åƒURLã®å„ªå…ˆé †ä½ã‚’è¨­å®šï¼ˆGAS/å¤–éƒ¨URL > .png > .jpgï¼‰
                        return {
                            nickname: m.nickname,
                            // ãƒ¡ãƒ³ãƒãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿æŒã•ã›ã‚‹
                            image_path: m.image || `images/member/${memberNumber}.png`,
                            secondary_path: `images/member/${memberNumber}.jpg`,
                            number: memberNumber
                        };
                    });
                    
                    LOADING_MESSAGE.textContent = "æº–å‚™å®Œäº†ï¼";
                    BUTTON.disabled = false;
                    
                } else {
                    LOADING_MESSAGE.textContent = "ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“ã€‚";
                }
            } catch (err) {
                LOADING_MESSAGE.textContent = "ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                console.error("ãƒ¡ãƒ³ãƒãƒ¼å–å¾—é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
            }
        }

        // ç”»åƒã‚’è¡¨ç¤ºãƒ»æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆã‚¨ãƒ©ãƒ¼å‡¦ç†å«ã‚€ï¼‰
        function updateResultImage(member) {
            RESULT_IMAGE.style.display = 'block';
            
            // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ãƒªã‚»ãƒƒãƒˆ
            RESULT_IMAGE.onerror = null; 
            
            // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’è¨­å®š
            let errorAttempts = 0;
            RESULT_IMAGE.onerror = function() {
                errorAttempts++;

                if (errorAttempts === 1) {
                    // 1å›ç›®ã‚¨ãƒ©ãƒ¼: GAS URL ã¾ãŸã¯ primary .png ãŒå¤±æ•—
                    // primary .png ãŒå¤±æ•—ã—ãŸã¨ä»®å®šã—ã€secondary .jpg ã‚’è©¦ã™
                    this.src = member.secondary_path;

                } else if (errorAttempts === 2) {
                    // 2å›ç›®ã‚¨ãƒ©ãƒ¼: secondary .jpg ã‚‚å¤±æ•—
                    this.src = DEFAULT_IMAGE_PATH; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç”»åƒã¸

                } else {
                    // 3å›ç›®ä»¥é™ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                    this.onerror = null; 
                }
            };
            
            // åˆæœŸã®ç”»åƒã‚½ãƒ¼ã‚¹ã‚’è¨­å®šï¼ˆã“ã“ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚Œã°onerrorãŒå‘¼ã°ã‚Œã‚‹ï¼‰
            RESULT_IMAGE.src = member.image_path;
        }


        // ãã˜å¼•ãé–‹å§‹
        function startKujibiki() {
            if (BUTTON.disabled || membersData.length === 0) return;
            
            BUTTON.disabled = true;
            RESULT_NAME.textContent = "ã‚·ãƒ£ãƒƒãƒ•ãƒ«ä¸­...";
            RESULT_IMAGE.style.display = 'none';

            let count = 0;
            
            // æŠ½é¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé«˜é€Ÿã§åå‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼‰
            intervalId = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * membersData.length);
                const currentMember = membersData[randomIndex];
                
                RESULT_NAME.textContent = currentMember.nickname;
                
                count++;
                
                // 1.5ç§’å¾Œã«åœæ­¢
                if (count > 20) {
                    clearInterval(intervalId);
                    
                    // æœ€çµ‚çµæœã‚’æ±ºå®š
                    setTimeout(stopKujibiki, 500); 
                }
            }, 75); 
        }

        // ãã˜å¼•ãåœæ­¢ãƒ»çµæœè¡¨ç¤º
        function stopKujibiki() {
            const finalIndex = Math.floor(Math.random() * membersData.length);
            const winner = membersData[finalIndex];

            RESULT_NAME.textContent = 'ğŸ‰ ' + winner.nickname + ' ğŸ‰';
            updateResultImage(winner); // å½“é¸è€…ã®ç”»åƒã‚’æ­£ã—ãè¡¨ç¤º
            
            BUTTON.disabled = false;
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
        window.onload = loadMembersForKujibiki;

    </script>
</body>
</html>
